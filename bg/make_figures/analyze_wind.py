import os
from dotenv import load_dotenv

from hybrid.sites import SiteInfo, flatirons_site
from hybrid.wind_source import WindPlant
from hybrid.keys import set_developer_nrel_gov_key
from hybrid.sites import flatirons_site as sample_site
from hybrid.log import hybrid_logger as logger

import json

import numpy as np


def init_wind_plant(tower_height,rotor_diameter,powercurve_filename,outage_start=0,outage_duration=0,wind_speed_multiplier=1.0):

    # Set API key
    load_dotenv()
    NREL_API_KEY = os.getenv("NREL_API_KEY")
    set_developer_nrel_gov_key(NREL_API_KEY)  # Set this key manually here if you are not setting it using the .env
    
    # Get resource
    lat = 40.966
    lon = -84.598
    year = 2012

    sample_site['year'] = year
    sample_site['lat'] = lat
    sample_site['lon'] = lon

    # Import powercurve
    powercurve_file = open(powercurve_filename)
    powercurve_data = json.load(powercurve_file)
    powercurve_file.close()

    site = SiteInfo(sample_site, hub_height=tower_height)

    data = site.wind_resource.data["data"]
    nhours = 8760
    for k in range(nhours):
        data[k][2] = data[k][2]*wind_speed_multiplier
        
    if outage_duration > 0.0:
        outage_start = 3000
        outage_duration = 3*24
        for i in range(outage_duration):
            data[outage_start+i][2] = 0.0

        site.wind_resource.data["data"] = data    



    # Set up HOPP models
    wind_plant = WindPlant(site, 20000)

    wind_plant.system_model.Turbine.wind_turbine_hub_ht = tower_height
    wind_plant.system_model.Turbine.wind_turbine_rotor_diameter = rotor_diameter
    wind_plant.system_model.Turbine.wind_turbine_powercurve_windspeeds = \
        powercurve_data['turbine_powercurve_specification']['wind_speed_ms']
    wind_plant.system_model.Turbine.wind_turbine_powercurve_powerout = \
        powercurve_data['turbine_powercurve_specification']['turbine_power_output']

    wind_plant.wake_model = 1

    logger.disabled = True

    return wind_plant


if __name__=="__main__":

    # Set API key
    load_dotenv()
    NREL_API_KEY = os.getenv("NREL_API_KEY")
    set_developer_nrel_gov_key(NREL_API_KEY)  # Set this key manually here if you are not setting it using the .env

    turbine_x = np.array([900606.2412354 , 902737.75480607, 901132.06839904, 900735.34423504,
       907060.10801373, 893251.83334044, 893236.65411634, 905622.38351097,
       894761.5657024 , 903700.33595102, 898760.21411487, 893302.86514622,
       903224.56338475, 898975.99953962, 900846.17231514, 893929.0896413 ,
       896620.4888362 , 897988.37399876, 896661.38814369, 905295.10954158,
       907258.1757981 , 898167.37141251, 895968.86882734, 893052.9081225 ,
       897306.03174514, 897947.1566924 , 894647.26897251, 905976.22466686,
       896819.39451732, 905389.16333238, 904109.01458555, 903294.41654319,
       894967.70937568, 904833.39030567, 898164.31152394, 903558.1104987 ,
       901489.4615303 , 905213.21964375, 896377.10770561, 901076.51268173,
       893223.97089685, 901287.14742635, 897589.98087299, 895916.47126033,
       901581.57085421, 904881.38825351, 900802.8683886 , 902130.81055745,
       902399.2592795 , 897676.2828538 , 897458.46637654, 900495.60278876,
       900180.06303267, 896016.84635715, 898589.1950557 , 906476.42030239,
       906220.41010714, 896887.04008032, 906340.88018649, 894969.11333078,
       899842.98592176, 905917.85953147, 895857.82413213, 897024.32776761,
       895517.02587763, 898356.52303918, 900208.24532764, 904334.05662134,
       892989.58340504, 900522.13058843, 902996.92196119, 897103.71341902,
       903057.40593036, 896600.5292921 , 896883.80856718, 902567.21697718,
       905923.65411578, 893521.03611829, 903821.6725594 , 905061.6408518 ,
       898293.7808051 , 902987.86652971, 897095.01799227, 895128.1832635 ,
       898714.31294831, 897237.63796762, 902032.33513417, 906562.40564183,
       905780.05581246, 899589.43743314, 904603.05514568, 893686.69709793,
       900063.54097853, 894625.13873297, 894853.95418797, 907715.68323743,
       904732.07505971, 903365.67889771, 896833.02273476, 907358.77948969,
       893971.00665973, 904877.78977037, 895806.49538945, 897776.62447351,
       899640.23565581, 900345.82359094, 894592.92640973, 900987.11244015,
       894261.39291976, 902680.48647033, 899015.5730209 , 896689.58209856,
       900863.46913437, 896883.22405002, 901938.39299534, 894054.96161938,
       900055.93744652, 900501.73985704, 906108.92242197, 903998.72516604,
       905760.90675404, 897497.98936243, 904511.53396106, 902726.81820957,
       896221.42061659, 898800.22629529, 897201.58598777, 900292.91670733,
       895583.62600704, 906703.30209055, 901596.868406  , 904269.86772031,
       906821.45432383, 901996.28087592, 895734.00025143, 899213.0316747 ,
       895089.18570525, 895290.36225118, 894000.24364844, 898872.94912946,
       894935.59072736, 906091.40011422, 894439.07874703, 900515.00061303,
       901825.62209691, 906468.80844059, 900910.52203854, 897453.09587657,
       904939.10211074, 900011.77549343, 898393.29047369, 898861.91649201])

    turbine_y = np.array([169681.47246136, 171011.66164696, 172197.65662485, 166690.5988866 ,
       165762.32472027, 169490.88261906, 165144.53396017, 164981.5022809 ,
       165787.53605764, 173539.47995088, 170642.40790834, 167967.06108785,
       174376.07077559, 165005.97582672, 168013.97261393, 169962.67962524,
       163007.62340969, 164301.49850273, 163975.47927747, 174109.76996823,
       163959.29825944, 169993.25099345, 166040.50796391, 166299.33856628,
       169548.92810035, 162684.86384183, 172713.14008759, 167910.83306008,
       162249.03248468, 173761.42069583, 163976.87880801, 172387.50487289,
       163958.97198804, 167753.11664486, 163868.54337991, 165425.00737948,
       168741.30660099, 167496.60724876, 161465.71189325, 165176.87841397,
       169950.82777473, 169076.37697483, 167857.0445229 , 165016.47128112,
       173305.92671507, 163359.99759654, 173663.19284965, 168804.34137544,
       173713.0943231 , 163117.91544172, 165668.07628292, 171347.91677434,
       167085.99465904, 163574.8085813 , 173281.79516927, 166252.26941576,
       173024.34806027, 173091.48647007, 167618.209688  , 162808.55833356,
       167846.03191934, 171385.07275285, 163924.21166003, 165915.37649461,
       172626.67053679, 169227.33518632, 169956.26364374, 163450.08710486,
       165581.25941568, 168284.79610385, 168072.74501949, 172712.48323947,
       172774.06982228, 162612.36765735, 167946.95803888, 172383.88087539,
       170606.0150708 , 169070.47453337, 164979.19321221, 165517.03216215,
       173960.29216859, 170678.56644687, 171027.69912885, 163638.0335135 ,
       166780.78725028, 171921.83062761, 170340.82538168, 170240.54810944,
       169549.07722334, 171649.98325363, 166697.25097288, 163464.64990443,
       171478.11028749, 167395.34558891, 172269.67640749, 163697.17424312,
       173532.23924801, 165717.47172125, 161269.33580129, 165541.2428195 ,
       168766.0246108 , 170500.70791281, 171694.21400763, 167502.7217967 ,
       169569.38938002, 165097.94795334, 169438.33492193, 173091.38590152,
       168137.20545143, 173402.33493509, 166121.6356626 , 171584.10124744,
       165548.7224495 , 166933.9529747 , 165397.40965134, 169585.52200284,
       168786.23115088, 166946.06596086, 163264.31308297, 172977.19395604,
       163481.73076205, 163893.71045218, 169372.55651233, 171946.63254517,
       165749.47125079, 173027.16949336, 164828.14927203, 172985.76214721,
       166664.48865239, 165966.32881449, 167532.94116041, 172595.49901642,
       165157.04595746, 169303.97729344, 166343.33141509, 173709.75469365,
       162451.76300161, 172958.1192272 , 164646.44835009, 166436.13630724,
       164767.37603913, 166963.4690337 , 167750.00138237, 164689.17074826,
       167212.08549194, 165355.664648  , 166357.72818858, 166721.44916627,
       168527.75913727, 170340.00800628, 173583.2411843 , 170163.87925452])

    # aep,lcoe,irr = analyze_site(turbine_x,turbine_y)

    # print("aep: ", aep)
    # print("lcoe: ", lcoe)
    # print("irr: ", irr)

    # plant = init_wind_plant(100.0,200.0,"turbine_data/high_7r_200d_135h.txt")
    plant = init_plant(100.0,200.0,"turbine_data/high_7r_200d_135h.txt")
    plant.wind.modify_coordinates(turbine_x,turbine_y)
    plant.simulate(1)
    print(plant.annual_energies.wind)

    plant = init_wind_plant(100.0,200.0,"turbine_data/high_7r_200d_135h.txt")
    plant.modify_coordinates(turbine_x,turbine_y)
    plant.simulate(1)
    print(plant.annual_energy_kw())